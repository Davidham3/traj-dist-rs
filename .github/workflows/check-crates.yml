name: Check crates.io (Dry-run)

on:
  push:
    branches: [main, develop]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      dry-run:
        description: 'Run dry-run check'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  check-crates:
    name: Check crates.io publishing
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Run cargo publish dry-run
        run: |
          echo "Running cargo publish dry-run..."
          cargo publish --dry-run --allow-dirty

      - name: Check package metadata
        run: |
          echo "Checking package metadata..."
          cargo package
          cargo package --list

      - name: Display package info
        run: |
          echo "Package information:"
          cargo metadata --format-version 1 --no-deps | jq '.packages[] | select(.name == "traj-dist-rs") | {name, version, description, license, repository}'

      - name: Verify version format
        run: |
          VERSION=$(grep '^version = ' Cargo.toml | sed 's/version = "\(.*\)"/\1/')
          echo "Current version: $VERSION"
          if [[ $VERSION == *"alpha"* ]] || [[ $VERSION == *"beta"* ]] || [[ $VERSION == *"rc"* ]]; then
            echo "⚠️  Warning: crates.io does not support pre-release versions ($VERSION)"
            echo "For crates.io, you need to use a stable version like 0.1.0, 0.2.0, etc."
            echo "This check will pass, but actual publishing will fail."
          else
            echo "✅ Version format is compatible with crates.io"
          fi