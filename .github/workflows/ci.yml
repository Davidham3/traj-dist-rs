name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # Job 1: Rust tests
  test-rust:
    name: Test Rust
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Run Rust tests
        run: cargo test --verbose

      - name: Run Rust integration tests
        run: cargo test --tests --verbose

  # Job 2: Python tests
  test-python:
    name: Test Python
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python dependencies with uv
        run: uv sync --dev

      - name: Build Python package
        run: uv run maturin develop

      - name: Run Python tests (CI only)
        run: uv run pytest py_tests/test_ci.py -v

      - name: Run README Python examples test
        run: uv run pytest py_tests/test_readme_examples.py -v

      - name: Run full Python tests (if data exists)
        run: |
          if [ -d "py_tests/data/cython_samples" ]; then
            uv run pytest py_tests/ -v --ignore=py_tests/test_ci.py
          else
            echo "Test data not found, skipping full Python tests"
          fi

  # Job 3: Check README Rust examples
  test-readme-rust:
    name: Test README Rust Examples
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Run README Rust examples test
        run: cargo test --test readme_examples -- --nocapture
