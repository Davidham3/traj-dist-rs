#!/bin/bash
# 预构建脚本：代码格式化、编译和全链路测试
# 任何代码变更完成后都应运行此脚本

set -e  # 遇到错误立即退出

# 切换到脚本所在目录的父目录（即项目根目录）
cd "$(dirname "$0")/.."

# 激活虚拟环境
source .venv/bin/activate

echo "=========================================="
echo "开始执行预构建流程"
echo "=========================================="

# ==========================================
# 步骤 1: Rust 代码格式化
# ==========================================
echo ""
echo "[1/9] Rust 代码格式化 (cargo fmt)..."
cargo fmt

# ==========================================
# 步骤 2: Rust 代码检查
# ==========================================
echo ""
echo "[2/9] Rust 代码检查 (cargo clippy)..."
cargo clippy -- -D warnings

# ==========================================
# 步骤 3: Rust 单元测试
# ==========================================
echo ""
echo "[3/9] Rust 单元测试 (cargo test)..."
cargo test

# ==========================================
# 步骤 4: 生成 Python 存根文件
# ==========================================
echo ""
echo "[4/11] 生成 Python 存根文件 (stub_gen)..."
# 如果 stub_gen 构建失败，继续执行（存根文件可能已经存在）
cargo run --features python-binding --bin stub_gen

# ==========================================
# 步骤 5: 删除干扰的 _lib 目录
# ==========================================
echo ""
echo "[5/11] 删除干扰的 _lib 目录..."
rm -rf python/traj_dist_rs/_lib

# ==========================================
# 步骤 6: Python 绑定构建
# ==========================================
echo ""
echo "[6/11] Python 绑定构建 (maturin develop)..."
maturin develop

# ==========================================
# 步骤 7: Python 代码清理
# ==========================================
echo ""
echo "[7/11] Python 代码清理 (autoflake)..."
autoflake --in-place --remove-all-unused-imports --remove-unused-variables python/**/*.py

# ==========================================
# 步骤 8: Python 代码格式化
# ==========================================
echo ""
echo "[8/11] Python 代码格式化 (black)..."
black python/

# ==========================================
# 步骤 9: Python import 排序
# ==========================================
echo ""
echo "[9/11] Python import 排序 (isort)..."
isort python/

# ==========================================
# 步骤 10: Python 代码检查和修复
# ==========================================
echo ""
echo "[10/11] Python 代码检查和修复 (ruff check --fix)..."
ruff check --fix python/ py_tests/

# ==========================================
# 步骤 11: Python 集成测试
# ==========================================
echo ""
echo "[11/11] Python 集成测试 (pytest)..."
pytest py_tests/

# ==========================================
# 完成
# ==========================================
echo ""
echo "=========================================="
echo "预构建流程成功完成！"
echo "=========================================="